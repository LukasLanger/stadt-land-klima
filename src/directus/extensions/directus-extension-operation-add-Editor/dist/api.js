var e="object"==typeof global&&global&&global.Object===Object&&global,t="object"==typeof self&&self&&self.Object===Object&&self,r=e||t||Function("return this")(),o=r.Symbol,n=Object.prototype,a=n.hasOwnProperty,c=n.toString,i=o?o.toStringTag:void 0;var l=Object.prototype.toString;var u="[object Null]",s="[object Undefined]",f=o?o.toStringTag:void 0;function b(e){return null==e?void 0===e?s:u:f&&f in Object(e)?function(e){var t=a.call(e,i),r=e[i];try{e[i]=void 0;var o=!0}catch(e){}var n=c.call(e);return o&&(t?e[i]=r:delete e[i]),n}(e):function(e){return l.call(e)}(e)}function p(e){return null!=e&&"object"==typeof e}var y=Array.isArray;function j(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var d="[object AsyncFunction]",m="[object Function]",v="[object GeneratorFunction]",g="[object Proxy]";function w(e){if(!j(e))return!1;var t=b(e);return t==m||t==v||t==d||t==g}var O,h=r["__core-js_shared__"],S=(O=/[^.]+$/.exec(h&&h.keys&&h.keys.IE_PROTO||""))?"Symbol(src)_1."+O:"";var A=Function.prototype.toString;function _(e){if(null!=e){try{return A.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var x=/^\[object .+?Constructor\]$/,P=Function.prototype,E=Object.prototype,F=P.toString,U=E.hasOwnProperty,M=RegExp("^"+F.call(U).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function T(e){return!(!j(e)||(t=e,S&&S in t))&&(w(e)?M:x).test(_(e));var t}function k(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return T(r)?r:void 0}var B=k(r,"WeakMap"),I=9007199254740991;function $(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=I}var R=Object.prototype;function D(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||R)}function q(e){return p(e)&&"[object Arguments]"==b(e)}var N=Object.prototype,V=N.hasOwnProperty,W=N.propertyIsEnumerable,z=q(function(){return arguments}())?q:function(e){return p(e)&&V.call(e,"callee")&&!W.call(e,"callee")};var C="object"==typeof exports&&exports&&!exports.nodeType&&exports,L=C&&"object"==typeof module&&module&&!module.nodeType&&module,G=L&&L.exports===C?r.Buffer:void 0,K=(G?G.isBuffer:void 0)||function(){return!1},Q={};Q["[object Float32Array]"]=Q["[object Float64Array]"]=Q["[object Int8Array]"]=Q["[object Int16Array]"]=Q["[object Int32Array]"]=Q["[object Uint8Array]"]=Q["[object Uint8ClampedArray]"]=Q["[object Uint16Array]"]=Q["[object Uint32Array]"]=!0,Q["[object Arguments]"]=Q["[object Array]"]=Q["[object ArrayBuffer]"]=Q["[object Boolean]"]=Q["[object DataView]"]=Q["[object Date]"]=Q["[object Error]"]=Q["[object Function]"]=Q["[object Map]"]=Q["[object Number]"]=Q["[object Object]"]=Q["[object RegExp]"]=Q["[object Set]"]=Q["[object String]"]=Q["[object WeakMap]"]=!1;var H,J="object"==typeof exports&&exports&&!exports.nodeType&&exports,X=J&&"object"==typeof module&&module&&!module.nodeType&&module,Y=X&&X.exports===J&&e.process,Z=function(){try{var e=X&&X.require&&X.require("util").types;return e||Y&&Y.binding&&Y.binding("util")}catch(e){}}(),ee=Z&&Z.isTypedArray,te=ee?(H=ee,function(e){return H(e)}):function(e){return p(e)&&$(e.length)&&!!Q[b(e)]};var re=function(e,t){return function(r){return e(t(r))}}(Object.keys,Object),oe=Object.prototype.hasOwnProperty;var ne=k(r,"Map"),ae=k(r,"DataView"),ce=k(r,"Promise"),ie=k(r,"Set"),le="[object Map]",ue="[object Promise]",se="[object Set]",fe="[object WeakMap]",be="[object DataView]",pe=_(ae),ye=_(ne),je=_(ce),de=_(ie),me=_(B),ve=b;(ae&&ve(new ae(new ArrayBuffer(1)))!=be||ne&&ve(new ne)!=le||ce&&ve(ce.resolve())!=ue||ie&&ve(new ie)!=se||B&&ve(new B)!=fe)&&(ve=function(e){var t=b(e),r="[object Object]"==t?e.constructor:void 0,o=r?_(r):"";if(o)switch(o){case pe:return be;case ye:return le;case je:return ue;case de:return se;case me:return fe}return t});var ge=ve,we=Object.prototype.hasOwnProperty;function Oe(e){if(null==e)return!0;if(function(e){return null!=e&&$(e.length)&&!w(e)}(e)&&(y(e)||"string"==typeof e||"function"==typeof e.splice||K(e)||te(e)||z(e)))return!e.length;var t=ge(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(D(e))return!function(e){if(!D(e))return re(e);var t=[];for(var r in Object(e))oe.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e).length;for(var r in e)if(we.call(e,r))return!1;return!0}var he={id:"operation-add-editor",handler:async({email:e,localteam_id:t},{logger:r,accountability:o,services:n,getSchema:a})=>{o.admin=!0,r.info(e,"email"),r.info(t,"localteam_id");const{UsersService:c,RolesService:i,MailService:l,ItemsService:u}=n,s=await a(),f=new c({schema:s,accountability:o}),b=new i({schema:s,accountability:o}),p=new u("localteams",{schema:s,accountability:o}),y=new l({schema:s,accountability:o});f.validateEmail(e);let j=f.inviteUrl(e);const d=await f.getUserByEmail(e),m=await b.readByQuery({fields:["*"],filter:{name:{_eq:"EditorLocalteam"}}});r.info(m[0].id);const v=await f.readOne(o.user,{fields:["id","first_name","last_name","email"]}),g=await p.readOne(t,{fields:["id","municipality_name"]}),w=v.first_name+" "+v.last_name;if(r.info(v),r.info(g),Oe(d)){await f.createOne({email:e,role:m[0].id,status:"invited",localteams:[{localteam_id:t}]});const r="Sie wurden zu Stadt.Land.Klima eingeladen! als Redakteur*in";await y.send({to:e,subject:r,template:{name:"email-template-invite",data:{url:j,email:e,fullName:w,municipality_name:g.name}}})}else if(d.role!==m[0].id)throw new Error("User has different role")}};export{he as default};
