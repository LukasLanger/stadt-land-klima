var e="object"==typeof global&&global&&global.Object===Object&&global,t="object"==typeof self&&self&&self.Object===Object&&self,r=e||t||Function("return this")(),o=r.Symbol,n=Object.prototype,a=n.hasOwnProperty,c=n.toString,i=o?o.toStringTag:void 0;var u=Object.prototype.toString;var l="[object Null]",b="[object Undefined]",s=o?o.toStringTag:void 0;function p(e){return null==e?void 0===e?b:l:s&&s in Object(e)?function(e){var t=a.call(e,i),r=e[i];try{e[i]=void 0;var o=!0}catch(e){}var n=c.call(e);return o&&(t?e[i]=r:delete e[i]),n}(e):function(e){return u.call(e)}(e)}function f(e){return null!=e&&"object"==typeof e}var y=Array.isArray;function j(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var d="[object AsyncFunction]",v="[object Function]",m="[object GeneratorFunction]",g="[object Proxy]";function O(e){if(!j(e))return!1;var t=p(e);return t==v||t==m||t==d||t==g}var w,h=r["__core-js_shared__"],A=(w=/[^.]+$/.exec(h&&h.keys&&h.keys.IE_PROTO||""))?"Symbol(src)_1."+w:"";var S=Function.prototype.toString;function x(e){if(null!=e){try{return S.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var _=/^\[object .+?Constructor\]$/,P=Function.prototype,E=Object.prototype,F=P.toString,U=E.hasOwnProperty,M=RegExp("^"+F.call(U).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function T(e){return!(!j(e)||(t=e,A&&A in t))&&(O(e)?M:_).test(x(e));var t}function B(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return T(r)?r:void 0}var k=B(r,"WeakMap"),$=9007199254740991;function I(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=$}var D=Object.prototype;function R(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||D)}function q(e){return f(e)&&"[object Arguments]"==p(e)}var V=Object.prototype,W=V.hasOwnProperty,C=V.propertyIsEnumerable,L=q(function(){return arguments}())?q:function(e){return f(e)&&W.call(e,"callee")&&!C.call(e,"callee")};var N="object"==typeof exports&&exports&&!exports.nodeType&&exports,z=N&&"object"==typeof module&&module&&!module.nodeType&&module,G=z&&z.exports===N?r.Buffer:void 0,K=(G?G.isBuffer:void 0)||function(){return!1},Q={};Q["[object Float32Array]"]=Q["[object Float64Array]"]=Q["[object Int8Array]"]=Q["[object Int16Array]"]=Q["[object Int32Array]"]=Q["[object Uint8Array]"]=Q["[object Uint8ClampedArray]"]=Q["[object Uint16Array]"]=Q["[object Uint32Array]"]=!0,Q["[object Arguments]"]=Q["[object Array]"]=Q["[object ArrayBuffer]"]=Q["[object Boolean]"]=Q["[object DataView]"]=Q["[object Date]"]=Q["[object Error]"]=Q["[object Function]"]=Q["[object Map]"]=Q["[object Number]"]=Q["[object Object]"]=Q["[object RegExp]"]=Q["[object Set]"]=Q["[object String]"]=Q["[object WeakMap]"]=!1;var Y,H="object"==typeof exports&&exports&&!exports.nodeType&&exports,J=H&&"object"==typeof module&&module&&!module.nodeType&&module,X=J&&J.exports===H&&e.process,Z=function(){try{var e=J&&J.require&&J.require("util").types;return e||X&&X.binding&&X.binding("util")}catch(e){}}(),ee=Z&&Z.isTypedArray,te=ee?(Y=ee,function(e){return Y(e)}):function(e){return f(e)&&I(e.length)&&!!Q[p(e)]};var re=function(e,t){return function(r){return e(t(r))}}(Object.keys,Object),oe=Object.prototype.hasOwnProperty;var ne=B(r,"Map"),ae=B(r,"DataView"),ce=B(r,"Promise"),ie=B(r,"Set"),ue="[object Map]",le="[object Promise]",be="[object Set]",se="[object WeakMap]",pe="[object DataView]",fe=x(ae),ye=x(ne),je=x(ce),de=x(ie),ve=x(k),me=p;(ae&&me(new ae(new ArrayBuffer(1)))!=pe||ne&&me(new ne)!=ue||ce&&me(ce.resolve())!=le||ie&&me(new ie)!=be||k&&me(new k)!=se)&&(me=function(e){var t=p(e),r="[object Object]"==t?e.constructor:void 0,o=r?x(r):"";if(o)switch(o){case fe:return pe;case ye:return ue;case je:return le;case de:return be;case ve:return se}return t});var ge=me,Oe=Object.prototype.hasOwnProperty;function we(e){if(null==e)return!0;if(function(e){return null!=e&&I(e.length)&&!O(e)}(e)&&(y(e)||"string"==typeof e||"function"==typeof e.splice||K(e)||te(e)||L(e)))return!e.length;var t=ge(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(R(e))return!function(e){if(!R(e))return re(e);var t=[];for(var r in Object(e))oe.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e).length;for(var r in e)if(Oe.call(e,r))return!1;return!0}var he={id:"operation-add-editor",handler:async({email:e,localteam_id:t},{env:r,logger:o,accountability:n,services:a,getSchema:c})=>{let i="EditorLocalteam";n.admin=!0,o.info(e,"email"),o.info(t,"localteam_id");const{UsersService:u,RolesService:l,MailService:b}=a,s=await c(),p=new u({schema:s,accountability:n}),f=new l({schema:s,accountability:n}),y=new b({schema:s,accountability:n});p.validateEmail(e);let j=p.inviteUrl(e);if(!we(await p.getUserByEmail(e)))throw new Error("User already exist");{const r=await f.readByQuery({fields:["*"],filter:{name:{_eq:i}}});o.info(r[0].id),await p.createOne({email:e,role:r[0].id,status:"invited",localteams:[{localteam_id:t}]});const n="You've been invited to Stadt.Land.Klima! as an "+i;await y.send({to:e,subject:n,template:{name:"user-invitation",data:{url:j,email:e}}})}}};export{he as default};
