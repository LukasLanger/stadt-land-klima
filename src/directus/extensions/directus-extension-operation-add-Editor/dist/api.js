var e="object"==typeof global&&global&&global.Object===Object&&global,t="object"==typeof self&&self&&self.Object===Object&&self,r=e||t||Function("return this")(),o=r.Symbol,n=Object.prototype,a=n.hasOwnProperty,c=n.toString,i=o?o.toStringTag:void 0;var u=Object.prototype.toString;var l="[object Null]",s="[object Undefined]",b=o?o.toStringTag:void 0;function f(e){return null==e?void 0===e?s:l:b&&b in Object(e)?function(e){var t=a.call(e,i),r=e[i];try{e[i]=void 0;var o=!0}catch(e){}var n=c.call(e);return o&&(t?e[i]=r:delete e[i]),n}(e):function(e){return u.call(e)}(e)}function p(e){return null!=e&&"object"==typeof e}var y=Array.isArray;function j(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var d="[object AsyncFunction]",v="[object Function]",m="[object GeneratorFunction]",g="[object Proxy]";function w(e){if(!j(e))return!1;var t=f(e);return t==v||t==m||t==d||t==g}var O,h=r["__core-js_shared__"],S=(O=/[^.]+$/.exec(h&&h.keys&&h.keys.IE_PROTO||""))?"Symbol(src)_1."+O:"";var A=Function.prototype.toString;function x(e){if(null!=e){try{return A.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var _=/^\[object .+?Constructor\]$/,P=Function.prototype,E=Object.prototype,F=P.toString,U=E.hasOwnProperty,M=RegExp("^"+F.call(U).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function T(e){return!(!j(e)||(t=e,S&&S in t))&&(w(e)?M:_).test(x(e));var t}function B(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return T(r)?r:void 0}var k=B(r,"WeakMap"),I=9007199254740991;function $(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=I}var D=Object.prototype;function R(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||D)}function q(e){return p(e)&&"[object Arguments]"==f(e)}var V=Object.prototype,W=V.hasOwnProperty,C=V.propertyIsEnumerable,L=q(function(){return arguments}())?q:function(e){return p(e)&&W.call(e,"callee")&&!C.call(e,"callee")};var N="object"==typeof exports&&exports&&!exports.nodeType&&exports,z=N&&"object"==typeof module&&module&&!module.nodeType&&module,G=z&&z.exports===N?r.Buffer:void 0,K=(G?G.isBuffer:void 0)||function(){return!1},Q={};Q["[object Float32Array]"]=Q["[object Float64Array]"]=Q["[object Int8Array]"]=Q["[object Int16Array]"]=Q["[object Int32Array]"]=Q["[object Uint8Array]"]=Q["[object Uint8ClampedArray]"]=Q["[object Uint16Array]"]=Q["[object Uint32Array]"]=!0,Q["[object Arguments]"]=Q["[object Array]"]=Q["[object ArrayBuffer]"]=Q["[object Boolean]"]=Q["[object DataView]"]=Q["[object Date]"]=Q["[object Error]"]=Q["[object Function]"]=Q["[object Map]"]=Q["[object Number]"]=Q["[object Object]"]=Q["[object RegExp]"]=Q["[object Set]"]=Q["[object String]"]=Q["[object WeakMap]"]=!1;var Y,H="object"==typeof exports&&exports&&!exports.nodeType&&exports,J=H&&"object"==typeof module&&module&&!module.nodeType&&module,X=J&&J.exports===H&&e.process,Z=function(){try{var e=J&&J.require&&J.require("util").types;return e||X&&X.binding&&X.binding("util")}catch(e){}}(),ee=Z&&Z.isTypedArray,te=ee?(Y=ee,function(e){return Y(e)}):function(e){return p(e)&&$(e.length)&&!!Q[f(e)]};var re=function(e,t){return function(r){return e(t(r))}}(Object.keys,Object),oe=Object.prototype.hasOwnProperty;var ne=B(r,"Map"),ae=B(r,"DataView"),ce=B(r,"Promise"),ie=B(r,"Set"),ue="[object Map]",le="[object Promise]",se="[object Set]",be="[object WeakMap]",fe="[object DataView]",pe=x(ae),ye=x(ne),je=x(ce),de=x(ie),ve=x(k),me=f;(ae&&me(new ae(new ArrayBuffer(1)))!=fe||ne&&me(new ne)!=ue||ce&&me(ce.resolve())!=le||ie&&me(new ie)!=se||k&&me(new k)!=be)&&(me=function(e){var t=f(e),r="[object Object]"==t?e.constructor:void 0,o=r?x(r):"";if(o)switch(o){case pe:return fe;case ye:return ue;case je:return le;case de:return se;case ve:return be}return t});var ge=me,we=Object.prototype.hasOwnProperty;function Oe(e){if(null==e)return!0;if(function(e){return null!=e&&$(e.length)&&!w(e)}(e)&&(y(e)||"string"==typeof e||"function"==typeof e.splice||K(e)||te(e)||L(e)))return!e.length;var t=ge(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(R(e))return!function(e){if(!R(e))return re(e);var t=[];for(var r in Object(e))oe.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e).length;for(var r in e)if(we.call(e,r))return!1;return!0}var he={id:"operation-add-editor",handler:async({email:e,localteam_id:t},{logger:r,accountability:o,services:n,getSchema:a})=>{let c="EditorLocalteam";o.admin=!0,r.info(e,"email"),r.info(t,"localteam_id");const{UsersService:i,RolesService:u,MailService:l,ItemsService:s}=n,b=await a(),f=new i({schema:b,accountability:o}),p=new u({schema:b,accountability:o}),y=new s("localteams",{schema:b,accountability:o}),j=new l({schema:b,accountability:o});f.validateEmail(e);let d=f.inviteUrl(e);const v=await f.getUserByEmail(e),m=await p.readByQuery({fields:["*"],filter:{name:{_eq:c}}});r.info(m[0].id);const g=await f.readOne(o.user,{fields:["id","first_name","last_name","email"]}),w=await y.readOne(t,{fields:["id","municipality_name"]});if(r.info(g),r.info(w),Oe(v)){await f.createOne({email:e,role:m[0].id,status:"invited",localteams:[{localteam_id:t}]});const r="You've been invited to Stadt.Land.Klima! as an "+c;await j.send({to:e,subject:r,template:{name:"user-invitation",data:{url:d,email:e}}})}else if(v.role!==m[0].id)throw new Error("User has different role")}};export{he as default};
