var t={id:"operation-calculateScores",handler:async({keys:t},{env:e,logger:a,accountability:i,services:o,getSchema:r,database:n})=>{try{const{ItemsService:e}=o,c=await r();i.admin=!0;const s=new e("ratings_measures",{schema:c,accountability:i}),l=new e("measures",{schema:c,accountability:i}),d=new e("municipalities",{schema:c,accountability:i});let u={limit:-1};const m=await s.readMany(t,u),E=await l.readByQuery(u),h=Object.values(m).map((t=>t.localteam_id));if(0===h.length)return void a.info("NOthing to recalc");u={filter:{localteam_id:{_in:h}}};const p=await d.readByQuery(u);for(const t of p){const e={};m.forEach((a=>{if(a.localteam_id===t.localteam_id){const t=E.find((t=>t.id===a.measure_id));void 0!==t&&(e[t.sector]={denominator:0,numerator:0})}})),e.total={denominator:0,numerator:0},a.info(e,"scoreDict"+t.name),u={filter:{_and:[{localteam_id:{_eq:t.localteam_id}}]}};const i=await s.readByQuery(u);a.info(i,"allRatingsMeasures");let o=i.map((t=>{const e=E.find((e=>e.id===t.measure_id));return null!=e.weight&&null!=e.sector?(t.weight=e.weight,t.sector=e.sector):(t.weight=0,t.sector="total"),t}));a.info(o,"ratingsMeasureDetail");for(const t of o){const{applicable:a,weight:i,approved:o,status:r,rating:n,sector:c}=t;a&&(e.total.denominator+=3*i,e[c]&&(e[c].denominator+=3*i),o&&"published"===r&&(e.total.numerator+=n*i,e[c]&&(e[c].numerator+=n*i)))}a.info(e,"scoreDict");let r={};for(const t in e)e.hasOwnProperty(t)&&(r["score_"+t]=e[t]=e[t].numerator/e[t].denominator,r["score_"+t]*="total"===t?100:10);a.info(r,"scoresToPush");await d.updateOne(t.id,r);n.raw("WITH RankedScores AS ( \t\t\t\t\t\t\t\tSELECT \t\t\t\t\t\t\t\tid, \t\t\t\t\t\t\t\tscore_total, \t\t\t\t\t\t\t\tDENSE_RANK() OVER (ORDER BY score_total DESC) AS place \t\t\t\t\t\t\t\tFROM \t\t\t\t\t\t\t\tpublic.municipalities \t\t\t\t\t\t\t\tWHERE status='published' \t\t\t\t\t\t\t) \t\t\t\t\t\t\t\t\t\t\t\t\tUPDATE public.municipalities AS t \t\t\t\t\t\t\tSET place = ( \t\t\t\t\t\t\t\tCASE \t\t\t\t\t\t\t\t\tWHEN t.status = 'published' THEN ( \t\t\t\t\t\t\t\t\t\tSELECT r.place \t\t\t\t\t\t\t\t\t\tFROM RankedScores r \t\t\t\t\t\t\t\t\t\tWHERE t.id = r.id \t\t\t\t\t\t\t\t\t\tLIMIT 1 \t\t\t\t\t\t\t\t\t) \t\t\t\t\t\t\t\t\tELSE -1 \t\t\t\t\t\t\t\tEND \t\t\t\t\t\t\t); \t\t\t\t\t").then((t=>{a.info(t,"resultsDB")})).catch((t=>{throw new ServiceUnavailableException(t.message)}))}}catch(t){a.info(t)}return{}}};export{t as default};
